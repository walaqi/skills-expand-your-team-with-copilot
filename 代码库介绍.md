# Mergington High School 活动管理系统 - 代码库介绍

## 一、代码库概述

这是一个完整的 Web 应用系统，用于管理 Mergington 高中的课外活动。该系统允许教师查看、注册和管理学生的课外活动报名。

### 主要技术栈
- **后端**: Python + FastAPI + MongoDB
- **前端**: 原生 JavaScript + HTML + CSS
- **部署**: GitHub Codespaces / 容器化开发环境

---

## 二、代码的主要功能

### 1. 活动管理
- **查看活动列表**: 展示所有可用的课外活动，包括活动描述、时间表、容量等信息
- **活动筛选**: 支持按日期、时间段、活动类别进行筛选
- **活动搜索**: 支持关键词搜索活动名称和描述

### 2. 学生注册管理
- **注册学生**: 教师可以为学生注册参加课外活动
- **取消注册**: 教师可以取消学生的活动报名
- **容量控制**: 自动检查活动容量限制，防止超额报名
- **实时显示**: 显示当前参与学生列表和剩余名额

### 3. 教师认证系统
- **教师登录**: 基于用户名和密码的登录系统
- **会话管理**: 使用 localStorage 保持登录状态
- **权限控制**: 只有登录的教师才能注册/取消注册学生

### 4. 数据持久化
- **MongoDB 数据库**: 存储活动信息和教师账户
- **初始数据**: 系统启动时自动初始化示例数据
- **数据验证**: 防止重复报名和数据冲突

---

## 三、模块结构及协同关系

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Frontend)                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  /src/static/                                        │   │
│  │  ├── index.html    (页面结构)                       │   │
│  │  ├── app.js        (业务逻辑)                       │   │
│  │  └── styles.css    (样式)                           │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP REST API
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                     后端 (Backend)                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  /src/app.py  (FastAPI 应用主入口)                   │  │
│  │  - 初始化 FastAPI 应用                              │  │
│  │  - 挂载静态文件目录                                  │  │
│  │  - 注册路由模块                                      │  │
│  └────────┬─────────────────────────────────────────────┘  │
│           │                                                  │
│  ┌────────▼─────────────────────────────────────────────┐  │
│  │  /src/backend/                                        │  │
│  │  ├── database.py         (数据库配置和初始化)        │  │
│  │  │   - MongoDB 连接                                  │  │
│  │  │   - 集合定义 (activities, teachers)              │  │
│  │  │   - 初始数据                                      │  │
│  │  │   - 密码哈希函数                                  │  │
│  │  │                                                    │  │
│  │  └── routers/               (路由模块)               │  │
│  │      ├── activities.py      (活动管理 API)           │  │
│  │      │   - GET  /activities (查询活动)              │  │
│  │      │   - GET  /activities/days (获取可用日期)     │  │
│  │      │   - POST /activities/{name}/signup (注册)   │  │
│  │      │   - POST /activities/{name}/unregister (取消)│  │
│  │      │                                               │  │
│  │      └── auth.py            (认证 API)               │  │
│  │          - POST /auth/login (教师登录)               │  │
│  │          - GET  /auth/check-session (会话验证)       │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│                    数据层 (Database)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  MongoDB (localhost:27017)                            │  │
│  │  ├── Database: mergington_high                        │  │
│  │  │   ├── Collection: activities (活动数据)           │  │
│  │  │   └── Collection: teachers (教师账户)             │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 详细模块说明

#### 1. 前端模块 (`/src/static/`)

##### **index.html** - 页面结构
- 定义应用的 HTML 结构
- 包含活动展示区、筛选侧边栏、登录/注册模态框
- 提供搜索框、类别筛选器、日期和时间筛选器

##### **app.js** - 前端业务逻辑
**核心功能模块：**

1. **状态管理**
   ```javascript
   - allActivities: 存储所有活动数据
   - currentFilter: 当前选中的类别筛选器
   - searchQuery: 搜索关键词
   - currentDay: 当前选中的日期筛选
   - currentTimeRange: 当前选中的时间段
   - currentUser: 当前登录用户信息
   ```

2. **API 交互函数**
   - `fetchActivities()`: 从后端获取活动列表
   - `login()`: 教师登录
   - `validateUserSession()`: 验证会话有效性
   - `handleUnregister()`: 取消学生注册

3. **UI 渲染函数**
   - `displayFilteredActivities()`: 展示筛选后的活动
   - `renderActivityCard()`: 渲染单个活动卡片
   - `updateAuthUI()`: 更新认证状态的 UI
   - `showLoadingSkeletons()`: 显示加载动画

4. **筛选和搜索**
   - 实时搜索功能
   - 多维度筛选 (类别、日期、时间)
   - 客户端和服务端混合筛选策略

##### **styles.css** - 样式定义
- 响应式布局设计
- 活动卡片样式
- 模态框动画
- 加载骨架屏

#### 2. 后端模块 (`/src/backend/`)

##### **app.py** - 应用入口
```python
核心职责：
1. 初始化 FastAPI 应用
2. 配置 API 文档 (标题、描述)
3. 初始化数据库
4. 挂载静态文件目录 (/static)
5. 设置根路径重定向
6. 注册路由模块 (activities, auth)
```

##### **database.py** - 数据库配置
```python
核心功能：
1. MongoDB 连接配置
   - 连接地址: mongodb://localhost:27017/
   - 数据库: mergington_high
   
2. 集合定义
   - activities_collection: 存储活动信息
   - teachers_collection: 存储教师账户

3. 数据初始化
   - initial_activities: 12 个预定义活动
   - initial_teachers: 3 个教师账户
   
4. 工具函数
   - hash_password(): Argon2 密码哈希
   - init_database(): 初始化空数据库
```

**活动数据结构：**
```javascript
{
  "_id": "Activity Name",
  "description": "活动描述",
  "schedule": "时间表文本",
  "schedule_details": {
    "days": ["Monday", "Friday"],
    "start_time": "15:15",
    "end_time": "16:45"
  },
  "max_participants": 12,
  "participants": ["email1@mergington.edu", ...]
}
```

##### **routers/activities.py** - 活动管理 API
```python
API 端点：

1. GET /activities
   - 获取所有活动列表
   - 支持筛选参数: day, start_time, end_time
   - 使用 MongoDB 查询进行服务端筛选

2. GET /activities/days
   - 获取所有有活动安排的日期列表
   - 使用 MongoDB 聚合管道去重

3. POST /activities/{activity_name}/signup
   - 为学生注册活动
   - 需要教师认证 (teacher_username)
   - 验证容量限制和重复报名

4. POST /activities/{activity_name}/unregister
   - 取消学生注册
   - 需要教师认证
   - 验证学生已报名
```

##### **routers/auth.py** - 认证 API
```python
API 端点：

1. POST /auth/login
   - 教师登录
   - 验证用户名和密码 (SHA-256 哈希)
   - 返回教师信息 (不含密码)

2. GET /auth/check-session
   - 验证会话有效性
   - 通过用户名查询教师信息
```

#### 3. 开发配置模块

##### **.vscode/launch.json** - 调试配置
- 定义 VS Code 调试启动配置
- 使用 uvicorn 运行 FastAPI 应用
- 启用热重载 (--reload)

##### **.devcontainer/** - 开发容器
- 使用 Python 3.13 容器镜像
- 自动安装依赖和配置 MongoDB
- 预装 GitHub Copilot 和 Python 扩展

---

## 四、模块间协同流程

### 流程 1: 用户查看活动列表

```
1. 用户访问网站
   └─> 浏览器加载 /static/index.html

2. app.js 初始化
   ├─> checkAuthentication() - 检查本地登录状态
   ├─> initializeFilters() - 初始化筛选器状态
   └─> fetchActivities() - 获取活动列表

3. fetchActivities() 调用后端 API
   └─> GET /activities?day=Monday&start_time=15:00
       (可选的筛选参数)

4. activities.py 处理请求
   ├─> 构建 MongoDB 查询条件
   ├─> 从 activities_collection 查询数据
   └─> 返回 JSON 格式的活动列表

5. app.js 接收数据
   ├─> 保存到 allActivities
   ├─> displayFilteredActivities() - 应用客户端筛选
   └─> renderActivityCard() - 渲染每个活动卡片

6. 用户看到活动列表
   └─> 包含活动信息、容量、参与学生等
```

### 流程 2: 教师登录

```
1. 用户点击 "Login" 按钮
   └─> openLoginModal() - 显示登录模态框

2. 用户输入用户名和密码，点击提交
   └─> loginForm submit event

3. app.js 调用后端
   └─> POST /auth/login?username=xxx&password=xxx

4. auth.py 处理登录
   ├─> hash_password() - 对密码进行 SHA-256 哈希
   ├─> 从 teachers_collection 查询教师
   ├─> 比对密码哈希
   └─> 返回教师信息 (username, display_name, role)

5. app.js 处理登录响应
   ├─> 保存用户信息到 currentUser
   ├─> localStorage.setItem() - 持久化到本地
   ├─> updateAuthUI() - 更新 UI 显示登录状态
   └─> 关闭登录模态框

6. UI 更新
   ├─> 显示教师名字和登出按钮
   ├─> 活动卡片显示 "Register Student" 按钮
   └─> 参与学生列表显示删除按钮
```

### 流程 3: 注册学生参加活动

```
1. 教师点击活动卡片上的 "Register Student" 按钮
   └─> openRegistrationModal(activityName)

2. 教师输入学生邮箱，点击提交
   └─> signupForm submit event

3. app.js 调用后端 API
   └─> POST /activities/{activity_name}/signup
       ?email=student@mergington.edu
       &teacher_username=mrodriguez

4. activities.py 处理注册请求
   ├─> 验证 teacher_username - 从 teachers_collection 查询
   ├─> 查询活动 - 从 activities_collection
   ├─> 验证学生未重复报名
   ├─> 验证容量未满
   ├─> $push 操作添加学生到 participants 数组
   └─> 返回成功消息

5. app.js 处理响应
   ├─> showMessage() - 显示成功消息
   ├─> closeRegistrationModalHandler() - 关闭模态框
   └─> fetchActivities() - 刷新活动列表

6. UI 更新
   └─> 活动卡片显示新的参与学生和更新的容量信息
```

### 流程 4: 筛选活动

```
客户端筛选 (即时响应):
- 类别筛选 (Sports, Arts, Academic, etc.)
- 搜索关键词
- 周末特殊筛选

服务端筛选 (减少数据传输):
- 日期筛选 (Monday, Tuesday, etc.)
- 时间段筛选 (Before School, After School)

混合策略:
1. 用户选择日期/时间筛选
   └─> fetchActivities() 带参数请求后端
       └─> 后端返回筛选后的数据

2. 用户选择类别或输入搜索词
   └─> displayFilteredActivities() 在客户端筛选
       └─> 不需要重新请求后端
```

---

## 五、关键设计亮点

### 1. 安全性考虑
- **密码哈希**: database.py 使用 Argon2，auth.py 使用 SHA-256
  - ⚠️ 注意：存在不一致，应统一使用 Argon2
- **认证验证**: 所有写操作都需要教师认证
- **数据验证**: 防止重复报名、容量溢出

### 2. 用户体验优化
- **骨架屏加载**: 提供流畅的加载体验
- **实时筛选**: 客户端筛选无需等待服务器响应
- **模态框动画**: 平滑的交互体验
- **确认对话框**: 防止误操作删除

### 3. 数据结构设计
- **双格式时间**: schedule (文本) + schedule_details (结构化)
- **文档 ID**: 使用活动名称作为 _id，简化查询
- **数组字段**: participants 使用数组存储，便于 $push/$pull 操作

### 4. 开发体验
- **热重载**: FastAPI 自动重载，开发时无需手动重启
- **API 文档**: 自动生成 Swagger UI (/docs)
- **容器化**: 开箱即用的开发环境

---

## 六、潜在改进建议

1. **密码哈希统一**: 将 auth.py 改为使用 Argon2 而非 SHA-256
2. **JWT 认证**: 替换简单的用户名验证为 JWT token
3. **数据验证**: 使用 Pydantic 模型验证请求数据
4. **错误处理**: 添加更详细的错误日志和用户友好的错误消息
5. **单元测试**: 添加后端 API 和前端函数的测试
6. **生产数据库**: 配置真实的 MongoDB 实例而非本地连接

---

## 七、快速开始指南

### 环境要求
- Python 3.13+
- MongoDB 运行在 localhost:27017

### 安装步骤

```bash
# 1. 安装依赖
pip install -r src/requirements.txt

# 2. 确保 MongoDB 正在运行
# (如果在 GitHub Codespaces 中，会自动启动)

# 3. 运行应用
python -m uvicorn src.app:app --reload

# 4. 访问应用
# 打开浏览器: http://localhost:8000
# API 文档: http://localhost:8000/docs
```

### 测试账户

```
用户名: mrodriguez
密码: art123

用户名: mchen
密码: chess456

用户名: principal
密码: admin789
```

---

## 八、总结

这是一个**结构清晰、功能完整**的全栈 Web 应用，采用了现代化的技术栈和最佳实践：

- ✅ **前后端分离**: 清晰的职责划分
- ✅ **RESTful API**: 标准的 API 设计
- ✅ **响应式 UI**: 良好的用户体验
- ✅ **数据持久化**: MongoDB 文档数据库
- ✅ **开发友好**: 容器化开发环境和热重载

代码库特别适合作为学习项目，展示了如何构建一个完整的课外活动管理系统。
